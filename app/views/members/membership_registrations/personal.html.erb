<%= content_for :club_header do %>
  <div class="bg-white rounded-[15px] flex flex-col justify-center items-center py-5 px-5">
    <%= image_tag serve_image_remote_url(@club.logo), class: "max-w-[200px] mb-5" %>
    <h2 class="text-3xl lg:text-3xl font-semibold text-center lg:text-start">
      New Membership
    </h2> 
  </div>
  <style>
    .club-header-color {
      background-color: blue;
    }
  </style>
<% end %>

<%= content_for :progress_bar do %>
  <%= render "members/membership_registrations/progress_bar", step_count: 1 %>
<% end %>

<% if @phase == :membership_type %>
  <div class="py-3 space-y-6">
    <h2 class="text-2xl lg:text-3xl font-semibold text-center lg:text-start mb-3">
      Personal Questions
    </h2> 
    <div class="space-y-2 text-center lg:text-start">
      <p class="text-sm text-slate-600">We filtered the available memberships based on your age and gender.</p>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-slate-50 px-5 py-4 text-sm text-slate-600">
      <div class="grid gap-3 md:grid-cols-3 md:items-center">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Name</p>
          <p class="font-semibold text-slate-900"><%= @form.first_name %> <%= @form.last_name %></p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Date of birth</p>
          <p class="font-semibold text-slate-900"><%= @form.date_of_birth.present? ? @form.date_of_birth.strftime("%d %B %Y") : "Derived from ID" %></p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Gender</p>
          <p class="font-semibold text-slate-900"><%= @form.gender_label || "Derived from ID" %></p>
        </div>
      </div>
    </div>

    <% if @eligible_membership_types.any? %>
      <%= form_with model: @form, url: members_membership_registration_path(step: "personal", club_id: @club.id), method: :patch, class: "space-y-5" do |f| %>
        <%= hidden_field_tag "membership_registration_form[phase]", "membership_type" %>
        <%= render "shared/form_errors", resource: @form if @form.errors.any? && lookup_context.exists?("shared/_form_errors") %>
        <div class="space-y-3">
          <% @eligible_membership_types.each do |membership_type| %>
            <% price = membership_type.current_price %>
            <label class="flex cursor-pointer flex-col gap-3 rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm transition hover:border-slate-300">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-base font-semibold text-slate-900"><%= membership_type.label %></p>
                  <p class="text-xs text-slate-500">Ages <%= membership_type.min_age_years %> – <%= membership_type.max_age_years %> • <%= membership_type.gender.titleize %></p>
                </div>
                <p class="text-sm font-semibold text-slate-900"><%= price.format %></p>
              </div>
              <div class="flex items-center gap-3">
                <%= f.radio_button :membership_type_id, membership_type.id, checked: @form.membership_type_id == membership_type.id, class: "h-4 w-4 border-slate-300 text-slate-900 focus:ring-slate-500" %>
                <span class="text-sm text-slate-600">Select this membership</span>
              </div>
            </label>
          <% end %>
        </div>

        <div class="flex items-center justify-between">
          <%= link_to "Edit details", members_membership_registration_path(step: "personal", club_id: @club.id, phase: "details"), class: "rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
          <%= f.submit "Next", class: "inline-flex min-w-[160px] items-center justify-center rounded-full bg-slate-900 px-6 py-3 text-sm font-semibold text-white shadow transition hover:bg-slate-800" %>
        </div>
      <% end %>
    <% else %>
      <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-6 py-8 text-center text-sm text-amber-700">
        <p class="font-semibold">No memberships available.</p>
        <p class="mt-1">Your age and gender do not match any membership types offered by <strong><%= @club.name %></strong>. Please adjust the personal details or contact the club.</p>
        <div class="mt-4">
          <%= link_to "Edit details", members_membership_registration_path(step: "personal", club_id: @club.id, phase: "details"), class: "rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="py-3">
    <%= form_with model: @form, url: members_membership_registration_path(step: "personal", club_id: @club.id), method: :patch, data: { controller: "sa-id" }, class: "space-y-8" do |f| %>
      <%= hidden_field_tag "membership_registration_form[phase]", "details" %>
      <%= render "shared/form_errors", resource: @form if @form.errors.any? && lookup_context.exists?("shared/_form_errors") %>

      <div class="grid gap-6 md:grid-cols-2">
        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Name</label>
          <%= f.text_field :first_name, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Surname</label>
          <%= f.text_field :last_name, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">ID Number</label>
          <%= f.text_field :id_number,
                class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "input" },
                maxlength: 13,
                pattern: "\\d{13}",
                required: true %>
          <p class="mt-1 text-xs text-slate-500">We’ll use this to derive your date of birth, gender, and nationality.</p>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Gender</label>
          <%= f.text_field :gender,
                value: @form.gender_label,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "gender" },
                readonly: true,
                placeholder: "Derived from ID" %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Nationality</label>
          <%= f.text_field :nationality,
                value: @form.nationality_label,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "nationality" },
                readonly: true,
                placeholder: "Derived from ID" %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Date of birth</label>
          <%= f.date_field :date_of_birth,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "dateOfBirth" },
                readonly: true %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Email address</label>
          <%= f.email_field :email, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div class="grid grid-cols-[auto_1fr] items-center gap-2 md:col-span-2 md:grid-cols-[minmax(0,140px)_1fr]">
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Country code</label>
            <%= f.select :mobile_country_code,
                  [["+27", "+27"], ["+264", "+264"], ["+44", "+44"], ["+1", "+1"]],
                  {},
                  class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                  required: true %>
          </div>
          <div>
            <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Mobile number</label>
            <%= f.telephone_field :mobile_number,
                  class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                  placeholder: "00 000 0000",
                  required: true %>
          </div>
        </div>
      </div>

      <label class="flex items-start gap-3 rounded-xl border border-slate-200 px-4 py-3 text-sm text-slate-600">
        <%= f.check_box :accept_personal_terms, required: true, class: "mt-1" %>
        <span>
          I confirm these details are accurate and I agree to share them with <strong><%= @club.name %></strong> for membership processing.
        </span>
      </label>

      <div class="flex items-center justify-between">
        <%= link_to "Cancel", members_dashboards_path, class: "rounded-full border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
        <%= f.submit "Next", class: "inline-flex min-w-[160px] items-center justify-center rounded-full bg-slate-900 px-6 py-3 text-sm font-semibold text-white shadow transition hover:bg-slate-800" %>
      </div>
    <% end %>
  </div>
<% end %>
