<% club ||= nil %>
<div class="relative mt-8 w-full max-w-md">
  <% if club&.logo.present? %>
    <div class="rounded-3xl bg-white px-6 py-10 shadow-2xl ring-1 ring-sky-100 mb-8 flex justify-center">
      <%= image_tag serve_image_remote_url(club.logo), alt: "#{club.name} logo", class: "max-h-32 w-auto" %>
    </div>
  <% end %>

  <div class="rounded-3xl bg-white px-6 py-10 shadow-2xl ring-1 ring-sky-100">
    <div class="mb-6 text-center">
      <h1 class="text-2xl font-semibold text-slate-900">Log in to Easyclub</h1>
      <p class="mt-2 text-sm text-slate-500">
        Access your memberships, payments, and club updates from one secure dashboard.
      </p>
    </div>

    <% current_login = @login_input.presence || resource.login.presence || resource.email.presence || params.dig(:user, :login) %>
    <% selected_country_code = @login_country_code.presence || resource.country_code.presence || params.dig(:user, :country_code).presence || "+27" %>
    <% selected_country_code = "+#{selected_country_code.to_s.gsub(/\D+/, "")}" if selected_country_code.present? %>
    <% initial_mode = @login_mode.present? ? @login_mode.to_s : (current_login.to_s.include?("@") ? "email" : "mobile") %>

    <% form_html_options = { class: "space-y-6" }
       form_html_options[:data] = { turbo: false } %>

    <%= form_for(resource, as: resource_name, url: session_path(resource_name), html: form_html_options) do |f| %>
      <% if club.present? %>
        <%= hidden_field_tag :club_id, club.to_param %>
      <% end %>

      <%= render "devise/shared/error_messages", resource: resource %>

      <div class="space-y-3" data-controller="login-method" data-login-method-mode-value="<%= initial_mode %>">
        <div class="space-y-3" data-login-method-target="mobileContainer">
          <div class="space-y-3 md:flex md:gap-3 md:space-y-0">
            <div data-controller="country-code-selector"
                 data-country-code-selector-initial-value="<%= selected_country_code %>">
              <%= tag.input type: "hidden",
                            name: "user[country_code]",
                            value: selected_country_code,
                          id: "login_country_code_selector",
                          data: {
                            country_code_selector_target: "input"
                          } %>
            <button type="button"
                    class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm transition hover:border-sky-400 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200"
                    data-country-code-selector-target="button"
                    data-action="country-code-selector#open">
              <span data-country-code-selector-target="buttonLabel" class="flex w-full items-center justify-between"></span>
            </button>

            <div class="fixed inset-0 z-50 hidden items-start justify-center bg-slate-900/50 px-4 py-16"
                 data-country-code-selector-target="overlay"
                 data-action="click->country-code-selector#overlayClick">
              <div class="w-full max-w-md rounded-3xl bg-white shadow-xl ring-1 ring-slate-200"
                   data-country-code-selector-target="dialog">
                <div class="flex items-center justify-between border-b border-slate-200 px-5 py-4">
                  <h2 class="text-sm font-semibold text-slate-900">Select country code</h2>
                  <button type="button"
                          class="rounded-full p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-200"
                          data-action="country-code-selector#close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                  </button>
                </div>
                <div class="px-5 py-4">
                  <input type="search"
                         placeholder="Search country or code"
                         aria-label="Search country or dial code"
                         class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200"
                         data-country-code-selector-target="search"
                         data-action="input->country-code-selector#filter">
                </div>
                <div class="max-h-80 overflow-y-auto" data-country-code-selector-target="list"></div>
              </div>
            </div>
            </div>

            <div class="md:flex-1"
                 data-controller="mobile-number"
                 data-mobile-number-code-value="<%= selected_country_code %>"
               data-mobile-number-country-input-value="login_country_code_selector">
            <%= text_field_tag "user[login]",
                               (initial_mode == "mobile" ? current_login : ""),
                               autocomplete: "tel",
                               inputmode: "tel",
                               placeholder: "Enter your mobile number",
                               class: "block w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",
                               data: {
                                 mobile_number_target: "input",
                                 "login-method-target": "mobileInput"
                             } %>
            </div>
          </div>

          <%# <p class="text-xs text-slate-400">Use your full mobile number including the country code.</p> %>
        </div>

        <div class="space-y-2 hidden" data-login-method-target="emailContainer">
          <%= text_field_tag "user[email_login]",
                             (initial_mode == "email" ? current_login : ""),
                             autocomplete: "email",
                             placeholder: "Email address",
                             class: "block w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",
                             data: { "login-method-target": "emailInput" } %>
        </div>

        <div>
          <%= f.label :password, class: "sr-only" %>
          <%= f.password_field :password,
                              autocomplete: "current-password",
                              placeholder: "Password",
                              class: "block w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200" %>
        </div>

        <div>
          <%= f.submit "Log in",
                        class: "w-full rounded-2xl bg-slate-900 px-4 py-3 text-sm font-semibold uppercase tracking-wide text-white shadow-lg transition hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-slate-300" %>
        </div>

        <div class="text-center">
          <button type="button"
                  class="mt-2 text-sm font-semibold text-sky-600 hover:text-sky-700"
                  data-action="login-method#toggle"
                  data-login-method-target="toggleButton">
            Log in via email
          </button>
        </div>
      </div>


      <% if devise_mapping.rememberable? %>
        <div class="flex flex-col gap-3 text-sm text-slate-500 sm:flex-row sm:items-center sm:justify-between">
          <label class="inline-flex items-center gap-2 text-slate-600">
            <%= f.check_box :remember_me,
                            class: "h-4 w-4 rounded border-slate-300 text-sky-500 focus:ring-sky-400" %>
            <span>Remember me</span>
          </label>
          <%= link_to "Forgot your password?",
                      new_password_path(resource_name, club_id: club&.to_param),
                      class: "font-semibold text-sky-600 hover:text-sky-700",
                      data: { turbo_frame: "_top" } %>
      </div>
      <% end %>

    <% end %>

    <div class="mt-6 text-center text-sm text-slate-500">
      Need an account?
      <%= link_to "Create one",
                  new_registration_path(resource_name, club_id: club&.to_param),
                  class: "font-semibold text-sky-600 hover:text-sky-700",
                  data: { turbo_frame: "_top" } %>
    </div>

    <div class="mt-4 flex items-center gap-4 text-xs uppercase tracking-wide text-slate-300">
      <div class="h-px flex-1 bg-slate-200"></div>
      <span>or</span>
      <div class="h-px flex-1 bg-slate-200"></div>
    </div>

    <div class="mt-4">
      <%= button_to user_google_oauth2_omniauth_authorize_path,
                    params: { club_id: club&.to_param },
                    method: :post,
                    form: { data: { turbo: false }, class: "w-full" },
                    class: "flex w-full items-center justify-center gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm font-medium text-slate-600 transition hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-sky-200" do %>
        <svg class="h-5 w-5" viewBox="0 0 48 48" aria-hidden="true">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.5 30.47 0 24 0 14.62 0 6.51 5.38 2.6 13.08l7.98 6.2C11.74 13.07 17.34 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.5 24.5c0-1.57-.14-3.06-.39-4.5H24v9h12.7c-.55 2.9-2.22 5.36-4.7 6.98l7.51 5.84C43.73 37.34 46.5 31.4 46.5 24.5z"/>
          <path fill="#FBBC05" d="M10.58 28.88c-.48-1.44-.76-2.99-.76-4.58 0-1.6.28-3.14.76-4.58l-7.98-6.2C.91 16.53 0 20.17 0 24.3c0 4.12.91 7.77 2.6 10.78l7.98-6.2z"/>
          <path fill="#34A853" d="M24 48c6.48 0 11.92-2.13 15.89-5.82l-7.51-5.84C30.3 37.89 27.3 38.9 24 38.9c-6.66 0-12.26-3.57-15.42-8.78l-7.98 6.2C6.51 42.62 14.62 48 24 48z"/>
          <path fill="none" d="M0 0h48v48H0z"/>
        </svg>
        Log in with Google
      <% end %>
    </div>
  </div>
</div>
