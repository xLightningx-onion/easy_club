<% frame_dom_id = frame_id || (plan.persisted? ? dom_id(plan) : dom_id(club, :staggered_payment_plan_form)) %>
<%= turbo_frame_tag frame_dom_id do %>
  <%= form_with model: [:admin, club, plan],
                class: "space-y-6",
                data: {
                  controller: "staggered-payment-plan",
                  action: "turbo:submit-end->staggered-payment-plan#handleSubmitEnd"
                } do |form| %>
    <% if plan.errors.any? %>
      <div class="rounded border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700">
        <%= plan.errors.full_messages.to_sentence %>
      </div>
    <% end %>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-1">
          <%= form.label :name, class: "text-sm font-medium text-slate-700" %>
          <%= form.text_field :name,
                              class: "w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring",
                              placeholder: "e.g. 3 payments over 3 months" %>
        </div>
        <div class="space-y-1">
          <%= form.label :active, class: "text-sm font-medium text-slate-700" %>
          <div class="flex items-center gap-2 rounded border border-slate-300 px-3 py-2">
            <%= form.check_box :active, class: "h-4 w-4 rounded border-slate-300 text-slate-900 focus:ring-slate-500" %>
            <span class="text-sm text-slate-600">Visible to club staff when creating checkouts</span>
          </div>
        </div>
      </div>

      <div class="space-y-1">
        <%= form.label :description, class: "text-sm font-medium text-slate-700" %>
        <%= form.text_area :description,
                           rows: 3,
                           class: "w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring",
                           placeholder: "Optional helper text for admins" %>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <div class="space-y-1">
          <%= form.label :starts_on, "Plan start date", class: "text-sm font-medium text-slate-700" %>
          <%= form.date_field :starts_on,
                              class: "w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring" %>
        </div>
        <div class="space-y-1">
          <%= form.label :ends_on, "Plan end date", class: "text-sm font-medium text-slate-700" %>
          <%= form.date_field :ends_on,
                              class: "w-full rounded border border-slate-300 px-3 py-2 text-sm focus:border-slate-500 focus:outline-none focus:ring" %>
        </div>
      </div>

      <div class="rounded-lg border border-slate-200 bg-slate-50 px-4 py-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-sm font-semibold text-slate-800">Installment summary</p>
            <p class="text-xs text-slate-500">Percentages must add up to 100% so the full order balance is covered.</p>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <span class="text-slate-500">Total</span>
            <span class="rounded-full bg-white px-3 py-1 text-sm font-semibold text-slate-900"
                  data-staggered-payment-plan-target="totalDisplay">0%</span>
          </div>
        </div>
      </div>

      <div class="space-y-4" data-staggered-payment-plan-target="list">
        <% plan.ordered_installments.each do |installment| %>
          <%= form.fields_for :installments, installment do |installment_fields| %>
            <%= render "admin/clubs/staggered_payment_plans/installment_fields",
                       form: installment_fields,
                       club: club %>
          <% end %>
        <% end %>
      </div>

      <div class="flex justify-between">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded border border-slate-300 px-3 py-2 text-sm font-medium text-slate-700 transition hover:bg-slate-100"
          data-action="staggered-payment-plan#addInstallment"
        >
          <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-slate-900 text-xs font-semibold text-white">+</span>
          Add installment
        </button>
      </div>

      <div class="flex justify-end gap-3">
        <button
          type="button"
          class="text-sm font-medium text-slate-500 hover:text-slate-700"
          data-action="modal#close"
        >
          Cancel
        </button>
        <%= form.submit(plan.persisted? ? "Save plan" : "Create plan",
                        class: "inline-flex items-center rounded bg-slate-900 px-4 py-2 text-sm font-medium text-white transition hover:bg-slate-800",
                        data: { staggered_payment_plan_target: "submit" }) %>
      </div>

      <template data-staggered-payment-plan-target="template">
        <%= form.fields_for :installments, StaggeredPaymentInstallment.new(due_on: plan.starts_on || Date.current), child_index: "NEW_RECORD" do |installment_fields| %>
          <%= render "admin/clubs/staggered_payment_plans/installment_fields",
                     form: installment_fields,
                     club: club %>
        <% end %>
      </template>
  <% end %>
<% end %>
