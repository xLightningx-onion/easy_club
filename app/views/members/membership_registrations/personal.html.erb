<%= content_for :club_header do %>
  <%= render "members/membership_registrations/club_header", club: @club %>
<% end %>

<%= content_for :progress_bar do %>
  <%= render "members/membership_registrations/progress_bar", step_count: 1 %>
<% end %>

<% if @phase == :membership_type %>
  <div class="py-3 space-y-6">
    <h2 class="text-2xl lg:text-3xl font-semibold text-center lg:text-start mb-3">
      Personal Questions
    </h2> 
    <div class="space-y-2 text-center lg:text-start">
      <p class="text-sm text-slate-600">We filtered the available memberships based on your age and gender.</p>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-slate-50 px-5 py-4 text-sm text-slate-600">
      <div class="grid gap-3 md:grid-cols-2 md:items-center">
        <div>
          <p class="text-xs uppercase tracking-wide text-slate-500">Name</p>
          <p class="font-semibold text-slate-900"><%= @form.first_name %> <%= @form.last_name %></p>
        </div>
        <div class="flex flex-row justify-between">
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-500">Date of birth</p>
            <p class="font-semibold text-slate-900"><%= @form.date_of_birth.present? ? @form.date_of_birth.strftime("%d %B %Y") : "Derived from ID" %></p>
          </div>
          <div>
            <p class="text-xs uppercase tracking-wide text-slate-500">Gender</p>
            <p class="font-semibold text-slate-900"><%= @form.gender_label || "Derived from ID" %></p>
          </div>
        </div>
      </div>
    </div>

    <% if @eligible_membership_types.any? %>
      <%= form_with model: @form, url: members_membership_registration_path(step: "personal", club_id: @club.id), method: :patch, class: "space-y-5" do |f| %>
        <%= hidden_field_tag "membership_registration_form[phase]", "membership_type" %>
        <%= f.hidden_field :member_id %>
        <%= render "shared/form_errors", resource: @form if @form.errors.any? && lookup_context.exists?("shared/_form_errors") %>
        <div class="space-y-3">
          <% @eligible_membership_types.each do |membership_type| %>
            <% price = membership_type.current_price %>
            <label class="flex cursor-pointer flex-col gap-3 rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm transition hover:border-slate-300">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="text-base font-semibold text-slate-900"><%= membership_type.label %></p>
                  <p class="text-xs text-slate-500">Ages <%= membership_type.min_age_years %> – <%= membership_type.max_age_years %> • <%= membership_type.gender.titleize %></p>
                </div>
                <p class="text-sm font-semibold text-slate-900"><%= price.format %></p>
              </div>
              <div class="flex items-center gap-3">
                <%= f.radio_button :membership_type_id, membership_type.id, checked: @form.membership_type_id == membership_type.id, class: "h-4 w-4 border-slate-300 text-slate-900 focus:ring-slate-500" %>
                <span class="text-sm text-slate-600">Select this membership</span>
              </div>
            </label>
          <% end %>
        </div>

        <div class="flex items-center justify-between">
          <%= link_to "Edit details", members_membership_registration_path(step: "personal", club_id: @club.id, phase: "details"), class: "rounded border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
          <%= f.submit "Next", class: "inline-flex min-w-[160px] items-center justify-center rounded bg-easyclub-primary px-6 py-3 text-sm font-semibold text-white shadow transition hover:bg-slate-800" %>
        </div>
      <% end %>
    <% else %>
      <div class="rounded-2xl border border-dashed border-amber-300 bg-amber-50 px-6 py-8 text-center text-sm text-amber-700">
        <p class="font-semibold">No memberships available.</p>
        <p class="mt-1">Your age and gender do not match any membership types offered by <strong><%= @club.name %></strong>. Please adjust the personal details or contact the club.</p>
        <div class="mt-4">
          <%= link_to "Edit details", members_membership_registration_path(step: "personal", club_id: @club.id, phase: "details"), class: "rounded border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="py-3 space-y-6">
    <% if @available_profiles.present? %>
      <div class="space-y-3 rounded-2xl border border-slate-200 bg-white px-5 py-4 shadow-sm">
        <div class="flex flex-col gap-1">
          <h3 class="text-base font-semibold text-slate-900">Use a saved profile</h3>
          <p class="text-sm text-slate-600">Select a member you have registered before to prefill their personal details.</p>
        </div>
        <div class="grid gap-3 grid-cols-1">
          <% @available_profiles.each do |profile| %>
            <% selected = @form.member_id.to_s == profile.id.to_s %>
            <%= link_to members_membership_registration_path(step: "personal", club_id: @club.id, phase: "details", profile_member_id: profile.id),
                        class: [
                          "flex flex-col gap-2 rounded-xl border px-4 py-3 text-left transition",
                          selected ? "border-sky-500 bg-sky-50 shadow-sm" : "border-slate-200 bg-white hover:border-slate-300"
                        ].join(" ") do %>
              <span class="text-sm font-semibold text-slate-900"><%= profile.display_name %></span>
              <span class="text-xs text-slate-500"><%= profile.club&.name %></span>
              <% if profile.dob.present? %>
                <span class="text-xs text-slate-500">Born <%= l(profile.dob, format: :long) %></span>
              <% end %>
              <% if profile.gender.present? %>
                <span class="text-xs text-slate-500 capitalize">Gender: <%= profile.gender %></span>
              <% end %>
              <span class="text-xs text-slate-400">Tap to load these details</span>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
    <%= form_with model: @form, url: members_membership_registration_path(step: "personal", club_id: @club.id), method: :patch, data: { controller: "sa-id" }, class: "space-y-8" do |f| %>
      <%= hidden_field_tag "membership_registration_form[phase]", "details" %>
      <%= f.hidden_field :member_id %>
      <%= render "shared/form_errors", resource: @form if @form.errors.any? && lookup_context.exists?("shared/_form_errors") %>

      <div class="grid gap-6 md:grid-cols-2">
        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Name</label>
          <%= f.text_field :first_name, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Surname</label>
          <%= f.text_field :last_name, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div class="md:col-span-2">
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">ID Number</label>
          <%= f.text_field :id_number,
                class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "input" },
                maxlength: 13,
                pattern: "\\d{13}",
                required: true %>
          <p class="mt-1 text-xs text-slate-500">We’ll use this to derive your date of birth, gender, and nationality.</p>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Gender</label>
          <%= f.text_field :gender,
                value: @form.gender_label,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "gender" },
                readonly: true,
                placeholder: "Derived from ID" %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Nationality</label>
          <%= f.text_field :nationality,
                value: @form.nationality_label,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "nationality" },
                readonly: true,
                placeholder: "Derived from ID" %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Date of birth</label>
          <%= f.date_field :date_of_birth,
                class: "w-full rounded-xl border border-slate-200 bg-slate-50 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring",
                data: { "sa-id-target": "dateOfBirth" },
                readonly: true %>
        </div>

        <div>
          <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500">Email address</label>
          <%= f.email_field :email, class: "w-full rounded-xl border border-slate-200 px-4 py-2 text-sm text-slate-700 focus:border-slate-500 focus:outline-none focus:ring", required: true %>
        </div>

        <div class="flex lg:flex-row gap-3 md:flex-row md:col-span-2">
          <div class="w-[20%] md:w-25" data-controller="country-code-selector"
              data-country-code-selector-initial-value="<%= '+27' %>">
            <%= f.hidden_field :country_code,
                              value: "+27",
                              data: { country_code_selector_target: "input" } %>
            <button type="button"
                    class="flex w-full items-center justify-between rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-700 shadow-sm focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200"
                    data-country-code-selector-target="button"
                    data-action="country-code-selector#open">
              <span data-country-code-selector-target="buttonLabel" class="flex w-full items-center justify-between"></span>
            </button>

            <div class="fixed inset-0 z-100 hidden justify-center bg-slate-900/50 px-4 py-16 flex items-center"
                data-country-code-selector-target="overlay"
                data-action="click->country-code-selector#overlayClick">
              <div class="w-full max-w-md rounded-3xl bg-white shadow-xl ring-1 ring-slate-200 pb-5"
                  data-country-code-selector-target="dialog">
                <div class="flex items-center justify-between border-b border-slate-200 px-5 py-4">
                  <h2 class="text-sm font-semibold text-slate-900">Select country code</h2>
                  <button type="button"
                          class="rounded-full p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700 focus:outline-none focus:ring-2 focus:ring-sky-200"
                          data-action="country-code-selector#close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                  </button>
                </div>
                <div class="px-5 py-4">
                  <input type="search"
                        placeholder="Search country or code"
                        aria-label="Search country or dial code"
                        class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200"
                        data-country-code-selector-target="search"
                        data-action="input->country-code-selector#filter">
                </div>
                <div class="max-h-80 overflow-y-auto" data-country-code-selector-target="list"></div>
              </div>
            </div>
          </div>

          <div class="w-[80%] lg:w-auto md:flex-1"
              data-controller="mobile-number"
              data-mobile-number-code-value="<%= '+27' %>"
              data-mobile-number-country-input-value="mobile_verification_country_code">
            <%= f.label :mobile_number, "Mobile number", class: "sr-only" %>
            <%= f.telephone_field :mobile_number,
                                  value: "",
                                  autocomplete: "tel-national",
                                  placeholder: "Mobile number",
                                  class: "block w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-900 placeholder-slate-400 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-200",
                                  data: { mobile_number_target: "input" } %>
          </div>
        </div>
      </div>

      <label class="flex items-start gap-3 rounded-xl border border-slate-200 px-4 py-3 text-sm text-slate-600">
        <%= f.check_box :accept_personal_terms, required: true, class: "mt-1" %>
        <span>
          I confirm these details are accurate and I agree to share them with <strong><%= @club.name %></strong> for membership processing.
        </span>
      </label>

      <div class="flex items-center justify-between">
        <%= link_to "Cancel", members_dashboards_path, class: "rounded border border-slate-200 px-5 py-2 text-sm font-semibold text-slate-600 transition hover:border-slate-300 hover:text-slate-900" %>
        <%= f.submit "Next", class: "inline-flex min-w-[160px] items-center justify-center rounded bg-easyclub-primary px-6 py-3 text-sm font-semibold text-white shadow transition hover:bg-slate-800" %>
      </div>
    <% end %>
  </div>
<% end %>
