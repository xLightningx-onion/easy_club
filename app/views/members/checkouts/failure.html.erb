<% content_for :title, "Payment failed · #{current_club&.name || @order&.club&.name || 'EasyClub'}" %>

<div class="mx-auto max-w-3xl px-4 py-12">
  <div class="overflow-hidden rounded-3xl border border-rose-200 bg-white shadow-sm">
    <div class="space-y-4 px-8 py-10 text-center">
      <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-rose-100 text-rose-600">
        <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
          <circle cx="12" cy="12" r="9" />
          <line x1="9" y1="9" x2="15" y2="15" />
          <line x1="15" y1="9" x2="9" y2="15" />
        </svg>
        <span class="sr-only">Payment failed</span>
      </div>
      <h1 class="text-2xl font-semibold text-slate-900">We couldn’t confirm your payment</h1>
      <p class="mx-auto max-w-2xl text-sm text-slate-600">
        <%= @error_message || "The payment was declined by the provider." %>
        Please review your details and try again.
      </p>
    </div>

    <% if @order %>
      <dl class="grid gap-6 border-t border-slate-100 px-8 py-6 text-sm text-slate-700 sm:grid-cols-2">
        <div>
          <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Order reference</dt>
          <dd class="mt-1 font-semibold text-slate-900"><%= @order.number %></dd>
        </div>
        <% amount_label =
             if defined?(@amount_attempted) && @amount_attempted.respond_to?(:format)
               @amount_attempted.format
             elsif defined?(@amount_attempted) && @amount_attempted.respond_to?(:[]) && @amount_attempted[:cents]
               number_to_currency(@amount_attempted[:cents] / 100.0, unit: @amount_attempted[:currency])
             else
               number_to_currency(@order.total_cents / 100.0, unit: @order.total_currency)
             end %>
        <div>
          <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Amount attempted</dt>
          <dd class="mt-1 font-semibold text-slate-900"><%= amount_label %></dd>
        </div>
        <% if @order.payment_mode_staggered? && @installment_details.present? %>
          <div>
            <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Installment</dt>
            <dd class="mt-1 font-medium text-slate-900">
              Installment <%= @installment_details[:number] || "–" %><% if @installment_count.positive? %> of <%= @installment_count %><% end %>
              <% if @installment_details[:due_at] %>
                · due <%= l(@installment_details[:due_at], format: :long) %>
              <% end %>
            </dd>
          </div>
        <% end %>
        <% if defined?(@outstanding_amount) && @outstanding_amount.respond_to?(:format) && @outstanding_amount.cents.positive? %>
          <div>
            <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Outstanding balance</dt>
            <dd class="mt-1 font-medium text-slate-900"><%= @outstanding_amount.format %></dd>
          </div>
        <% end %>
        <% if @transaction %>
          <div>
            <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Gateway reference</dt>
            <dd class="mt-1 font-medium text-slate-900"><%= @transaction.response_reference || @transaction.request_reference || "Not available" %></dd>
          </div>
          <% if (code = @transaction.metadata&.fetch("result_code", nil)) %>
            <div>
              <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Result code</dt>
              <dd class="mt-1 font-medium text-slate-900"><%= code %></dd>
            </div>
          <% end %>
          <div>
            <dt class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">Recorded at</dt>
            <dd class="mt-1 font-medium text-slate-900"><%= @transaction.updated_at ? l(@transaction.updated_at, format: :long) : "Pending" %></dd>
          </div>
        <% end %>
      </dl>
    <% end %>

    <aside class="space-y-4 border-t border-slate-200 bg-slate-50 px-8 py-6 text-sm text-slate-600">
      <div class="flex flex-wrap items-center justify-center gap-3">
        <%= link_to "Try again",
                    members_cart_path(club_id: @order&.club_id || current_club&.id, cart_id: @order&.cart_id, order_id: @order&.id, resume: true),
                    class: "inline-flex min-w-[200px] items-center justify-center rounded-full bg-slate-900 px-5 py-2 text-sm font-semibold text-white shadow transition hover:bg-slate-800" %>
        <%= link_to "Back to dashboard", members_dashboards_path,
                    class: "inline-flex min-w-[200px] items-center justify-center rounded-full border border-slate-300 px-5 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-400 hover:text-slate-900" %>
      </div>
    </aside>
  </div>
</div>
