<% greeting_name = current_user.first_name.presence || current_user.email.split("@").first %>
<% content_for :half_moon_header do %>
  <div class="absolute top-0 left-0 w-full h-[40vw] md:h-[15vw] overflow-x-hidden flex justify-center z-[1]">
    <div class="absolute w-[160vw] h-[200vw] left-1/2 -translate-x-1/2 club-header-color bg-easyclub-primary top-[-160vw] lg:top-[-185vw] rounded-[50%] z-0"></div>
  </div>
<% end %>
<section
  class="mx-auto max-w-5xl space-y-10 px-4 pb-10 relative z-[2] "
  data-controller="modal membership-start"
  data-membership-start-url-value="<%= members_membership_registration_path %>"
  data-action="turbo:submit-end->modal#handleSubmitEnd memberships-selection:club-selected@window->membership-start#begin"
>
  <header class="relative overflow-hidden p-6 text-dark-grey">
    <%# <div class="absolute -right-10 -top-10 h-40 w-40 rounded-full bg-white/10 blur-2xl"></div> %>
    <div class="relative z-10 flex flex-col gap-2">
      <div class="w-full flex justify-center">
        <%= image_tag 'easyclub-logo.png', class: "w-[50%] md:w-[20%]" %>
      </div>
      <div>
        <p class="text-xs text-center font-semibold text-white uppercase tracking-[0.3em] ">My Profile</p>
        <h1 class="mt-2 text-2xl text-center text-white font-semibold sm:text-3xl">Hi <%= greeting_name %></h1>
      </div>
      <div class="flex flex-row gap-3 justify-center">
        <div class="w-[25vw] md:w-[15vw]">
          <button
            type="button"
            class="flex items-end w-full md:items-center aspect-square md:aspect-auto justify-center rounded-xl bg-white px-8 py-3 text-xs text-center text-slate-900 transition hover:bg-slate-100"
            data-action="modal#open"
            data-modal-url="<%= new_members_selection_path %>"
            data-modal-title="Select a club">
            Add New Membership
          </button>
        </div>

        <div class="w-[25vw] md:w-[15vw]">
          <%= link_to "My Account",
          "",
          class: "flex items-end md:items-center w-full h-full aspect-square md:aspect-auto justify-center rounded-xl bg-white px-8 py-3 text-xs text-center transition hover:bg-slate-100" %>
        </div>
        <%#= link_to "Log out",
          destroy_user_session_path,
          data: { turbo_method: :delete },
          class: "flex items-center justify-center rounded-xl border border-white/40 px-6 py-3 text-sm font-semibold transition hover:bg-white/10" %>
      </div>
    </div>
  </header>

  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">My Memberships</h2>
      <% if @membership_profiles.any? %>
        <span class="text-xs font-medium uppercase tracking-wide text-slate-400"><%= pluralize(@membership_profiles.count, "membership") %></span>
      <% end %>
    </div>

    <% if @membership_profiles.any? %>
      <div class="grid gap-4">
        <% @membership_profiles.each do |membership| %>
          <% club = membership.club %>
          <% status = membership.status.presence || "unpaid" %>
          <% status_pill_classes = case status.to_s
                                    when "active" then "bg-emerald-100 text-emerald-700"
                                    when "partially_paid" then "bg-sky-100 text-sky-700"
                                    when "unpaid" then "bg-amber-100 text-amber-700"
                                    when "suspended" then "bg-rose-100 text-rose-600"
                                    else "bg-slate-100 text-slate-600"
                                  end %>
          <article class="flex items-center gap-4 rounded-2xl border border-slate-200 bg-white px-4 py-4 shadow-sm transition hover:border-slate-300">
            <div class="h-14 w-14 flex-shrink-0 overflow-hidden rounded-xl bg-slate-100">
              <% if club&.logo&.attached? %>
                <%= image_tag serve_image_remote_url(club.logo, resize_spec: "resize_to_fill", size_curves: [112, 112]), alt: "#{club.name} logo", class: "h-full w-full object-cover" %>
              <% else %>
                <div class="flex h-full w-full items-center justify-center text-xs font-semibold uppercase tracking-wide text-slate-400">
                  <%= club&.name&.first(2) || "CL" %>
                </div>
              <% end %>
            </div>
            <div class="flex flex-1 flex-col gap-1">
              <p class="text-sm font-semibold text-slate-900"><%= club&.name || "Club pending" %></p>
              <p class="text-sm text-slate-500"><%= membership.full_name.presence || "Member profile" %></p>
            </div>
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= status_pill_classes %> capitalize">
              <%= status.tr("_", " ") %>
            </span>
          </article>
        <% end %>
      </div>
    <% else %>
      <div class="rounded-2xl border border-dashed border-slate-300 bg-white px-6 py-10 text-center">
        <p class="text-sm font-medium text-slate-700">No memberships yet</p>
        <p class="mt-1 text-sm text-slate-500">Tap “Add New Membership” above to get started.</p>
      </div>
    <% end %>
  </div>

  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">My Carts</h2>
      <% if @open_carts.any? %>
        <span class="text-xs font-medium uppercase tracking-wide text-slate-400"><%= pluralize(@open_carts.count, "cart") %></span>
      <% end %>
    </div>

    <% if @open_carts.any? %>
      <div class="grid gap-4">
        <% @open_carts.each do |cart| %>
          <% club = cart.club %>
          <% members = cart.cart_items.map { |item| item.member&.display_name }.compact %>
          <% status_classes = case cart.status
                              when "pending_payment" then "bg-amber-100 text-amber-700"
                              when "partially_paid" then "bg-sky-100 text-sky-700"
                              when "unpaid" then "bg-slate-100 text-slate-600"
                              else "bg-slate-100 text-slate-600"
                              end %>
          <% display_total_money = cart.display_total_for_mode(mode: cart.payment_mode, cart_items: cart.cart_items) %>
          <article class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white px-4 py-4 shadow-sm transition hover:border-slate-300">
            <header class="flex items-start justify-between gap-3">
              <div class="flex items-center gap-3">
                <div class="h-12 w-12 flex-shrink-0 overflow-hidden rounded-xl bg-slate-100">
                  <% if club&.logo&.attached? %>
                    <%= image_tag serve_image_remote_url(club.logo, resize_spec: "resize_to_fill", size_curves: [96, 96]), alt: "#{club.name} logo", class: "h-full w-full object-cover" %>
                  <% else %>
                    <div class="flex h-full w-full items-center justify-center text-xs font-semibold uppercase tracking-wide text-slate-400">
                      <%= club&.name&.first(2) || "CL" %>
                    </div>
                  <% end %>
                </div>
                <div>
                  <p class="text-sm font-semibold text-slate-900"><%= club&.name || "Club checkout" %></p>
                  <p class="text-xs text-slate-500">Last updated <%= time_ago_in_words(cart.updated_at) %> ago</p>
                </div>
              </div>
              <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold <%= status_classes %> capitalize">
                <%= cart.status.tr("_", " ") %>
              </span>
            </header>

            <div class="grid gap-2 text-sm text-slate-600 sm:grid-cols-2">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-400">Cart total</p>
                <p class="font-semibold text-slate-900"><%= number_to_currency(display_total_money.cents / 100.0, unit: display_total_money.currency.iso_code) %></p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-400">Payment option</p>
                <p class="font-semibold text-slate-900">
                  <%= cart.payment_mode_staggered? && cart.staggered_payment_plan ? cart.staggered_payment_plan.name : "Pay in full" %>
                </p>
              </div>
              <% if cart.status_partially_paid? && cart.staggered_schedule.present? %>
                <% total_paid_money = cart.amount_paid_so_far %>
                <% next_installment = cart.next_installment %>
                <% outstanding_money = cart.outstanding_balance %>
                <div class="sm:col-span-2">
                  <div class="space-y-3 rounded-lg border border-sky-100 bg-sky-50 px-4 py-3">
                    <div class="grid gap-3 sm:grid-cols-3 sm:items-start">
                      <div>
                        <p class="text-xs uppercase tracking-wide text-slate-400">Paid so far</p>
                        <p class="text-sm font-semibold text-slate-900">
                          <%= number_to_currency(total_paid_money.cents / 100.0, unit: total_paid_money.currency.iso_code) %>
                        </p>
                      </div>
                      <div class="sm:col-span-2">
                        <p class="text-xs uppercase tracking-wide text-slate-400">Next installment</p>
                        <% if next_installment %>
                          <% next_amount = next_installment.amount %>
                          <% due_time = next_installment.due_at %>
                          <div class="mt-1 flex flex-wrap items-center gap-3 text-sm text-slate-900">
                            <span class="font-semibold">
                              <%= number_to_currency(next_amount.cents / 100.0, unit: next_amount.currency.iso_code) %>
                            </span>
                            <span class="text-xs text-slate-500">
                              <% if due_time.present? %>
                                Due <%= l(due_time, format: :long) %>
                              <% else %>
                                Date to be confirmed
                              <% end %>
                            </span>
                            <%= link_to "Pay now",
                                        cart.order ? members_cart_path(club_id: cart.club_id, cart_id: cart.id, order_id: cart.order.id, resume: true) : members_cart_path(club_id: cart.club_id),
                                        class: "inline-flex items-center rounded-full bg-slate-900 px-4 py-1.5 text-xs font-semibold text-white shadow transition hover:bg-slate-800" %>
                          </div>
                        <% else %>
                          <p class="mt-1 text-sm text-slate-600">All installments have been settled.</p>
                        <% end %>
                      </div>
                    </div>
                    <div>
                      <p class="text-xs uppercase tracking-wide text-slate-400">Outstanding balance</p>
                      <p class="text-sm font-semibold text-slate-900">
                        <%= number_to_currency(outstanding_money.cents / 100.0, unit: outstanding_money.currency.iso_code) %>
                      </p>
                    </div>
                  </div>
                </div>
              <% end %>
              <% if members.any? %>
                <div class="sm:col-span-2">
                  <p class="text-xs uppercase tracking-wide text-slate-400">Memberships</p>
                  <p class="text-sm text-slate-600"><%= members.join(", ") %></p>
                </div>
              <% end %>
            </div>

            <div class="flex flex-wrap items-center justify-end gap-3">
              <% if cart.order.present? %>
                <%= link_to "View order details",
                            members_order_path(cart.order),
                            class: "inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-400 hover:text-slate-900" %>
              <% else %>
                <%= link_to "Resume checkout",
                            members_cart_path(club_id: cart.club_id),
                            class: "inline-flex items-center justify-center rounded-full border border-slate-300 px-5 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-400 hover:text-slate-900" %>
              <% end %>
            </div>
          </article>
        <% end %>
      </div>
    <% else %>
      <div class="rounded-2xl border border-dashed border-slate-300 bg-white px-6 py-10 text-center">
        <p class="text-sm font-medium text-slate-700">No open checkouts</p>
        <p class="mt-1 text-sm text-slate-500">Start a new membership to create a fresh cart.</p>
      </div>
    <% end %>
  </div>

  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold text-slate-900">My Club Shops</h2>
      <% if @known_clubs.any? %>
        <span class="text-xs font-medium uppercase tracking-wide text-slate-400"><%= pluralize(@known_clubs.count, "club") %></span>
      <% end %>
    </div>

    <% if @known_clubs.any? %>
      <div class="flex flex-wrap gap-4">
        <% @known_clubs.each do |club| %>
          <%= link_to "#",
            class: "flex h-16 w-16 items-center justify-center rounded-2xl border border-slate-200 bg-white shadow-sm transition hover:border-slate-300" do %>
            <% if club.logo&.attached? %>
              <%= image_tag serve_image_remote_url(club.logo, resize_spec: "resize_to_fill", size_curves: [128, 128]), alt: "#{club.name} logo", class: "h-14 w-14 rounded-xl object-cover" %>
            <% else %>
              <span class="text-sm font-semibold uppercase text-slate-500"><%= club.name.first(2) %></span>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="rounded-2xl border border-dashed border-slate-300 bg-white px-6 py-10 text-center">
        <p class="text-sm text-slate-500">You’ll see your favourite club shops here once you join a club.</p>
      </div>
    <% end %>
  </div>

  <div
    class="fixed inset-0 z-50 hidden"
    data-modal-target="wrapper"
    data-action="keydown.esc->modal#close"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    tabindex="-1"
  >
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" data-action="click->modal#close"></div>
    <div class="relative z-10 flex min-h-full items-center justify-center p-4">
      <div class="w-full max-w-xl overflow-hidden rounded-3xl bg-white shadow-xl">
        <header class="flex items-center justify-between border-b border-slate-200 px-5 py-4">
          <h3 class="text-base font-semibold text-slate-900" data-modal-target="title">Select a club</h3>
          <button
            type="button"
            class="rounded-full p-2 text-slate-500 transition hover:bg-slate-100 hover:text-slate-700"
            data-action="modal#close"
            aria-label="Close modal"
            data-modal-initial-focus
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </header>
        <div class="px-5 py-6">
          <turbo-frame
            id="members_selection_modal"
            data-modal-target="frame"
            loading="lazy"
          ></turbo-frame>
        </div>
      </div>
    </div>
  </div>
</section>
