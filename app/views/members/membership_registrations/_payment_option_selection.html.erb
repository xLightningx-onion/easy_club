<div
  class="space-y-4"
  data-controller="payment-plan-selector"
  data-payment-plan-selector-mode-value="<%= @selected_payment_mode %>"
  data-payment-plan-selector-plan-id-value="<%= @selected_payment_plan_id %>"
  data-payment-plan-selector-preview-url-value="<%= members_membership_registration_path(step: "payment_option",
                                                                                       club_id: @club.id,
                                                                                       format: :turbo_stream) %>"
>
  <%= hidden_field_tag "membership_registration_form[payment_mode]",
                       @selected_payment_mode.presence || "full",
                       data: { payment_plan_selector_target: "modeField" } %>
  <%= hidden_field_tag "membership_registration_form[staggered_payment_plan_id]",
                       @selected_payment_plan_id,
                       data: { payment_plan_selector_target: "planField" } %>

  <% selected_mode = @selected_payment_mode.presence || "full" %>
  <% full_total_money = @payment_totals_by_mode.fetch("full", @cart_total_money) %>
  <% staggered_total_money = @payment_totals_by_mode.fetch("staggered", @staggered_total_money || @cart_total_money) %>
  <% full_total_formatted = number_to_currency(full_total_money.cents / 100.0, unit: full_total_money.currency.iso_code) %>

  <% full_selected = selected_mode != "staggered" %>
  <% full_label_classes = [
       "flex cursor-pointer flex-col gap-2 rounded border bg-slate-50 px-4 py-3 text-sm transition hover:border-slate-400",
       full_selected ? "border-slate-900 shadow-sm" : "border-slate-300"
     ].join(" ") %>
  <label
    class="<%= full_label_classes %>"
    data-payment-plan-selector-target="toggle"
  >
    <div class="flex items-start justify-between gap-3">
      <div class="flex items-start">
        <input type="radio"
               name="membership_registration_form[payment_plan_choice]"
               value="full"
               class="mr-3 m-auto h-4 w-4 border-slate-300 text-slate-900 focus:ring-slate-500"
               data-payment-plan-selector-target="input"
               data-action="payment-plan-selector#select"
               data-summary-label="Pay in full"
               <%= "checked" if full_selected %>>
        <span class="font-semibold text-slate-900">Pay in Full</span>
      </div>
      <strong class="text-slate-900"><%= full_total_formatted %></strong>
    </div>
    <p class="text-xs text-slate-500">The full amount is charged immediately.</p>
  </label>

  <% @staggered_payment_plans.each do |plan| %>
    <% breakdown = @plan_pricing[plan.id] || [] %>
    <% summary_text = "#{plan.name} Â· #{breakdown.size} payment#{'s' unless breakdown.size == 1}" %>
    <% plan_selected = selected_mode == "staggered" && plan.id.to_s == @selected_payment_plan_id.to_s %>
    <% plan_label_classes = [
         "flex cursor-pointer flex-col gap-1 rounded border bg-white px-4 py-3 text-sm transition hover:border-slate-400",
         plan_selected ? "border-slate-900 shadow-sm" : "border-slate-300"
       ].join(" ") %>
    <label
      class="<%= plan_label_classes %>"
      data-payment-plan-selector-target="toggle"
    >
      <div class="flex items-start gap-3">
        <input type="radio"
               name="membership_registration_form[payment_plan_choice]"
               value="staggered"
               class="m-auto h-4 w-4 border-slate-300 text-slate-900 focus:ring-slate-500"
               data-payment-plan-selector-target="input"
               data-action="payment-plan-selector#select"
               data-plan-id="<%= plan.id %>"
               data-summary-label="<%= summary_text %>"
               <%= "checked" if plan_selected %>>
        <div class="flex-1 space-y-2">
          <div class="flex items-center justify-between gap-3">
            <span class="font-semibold text-slate-900"><%= plan.name %></span>
            <% total_cents = breakdown.sum { |(_, amount)| amount.cents } %>
            <% total_amount = Money.new(total_cents, (@base_price || @cart_total_money).currency.iso_code) %>
            <% breakdown&.take(1).each_with_index do |(installment, amount), idx| %>
              <strong class="text-slate-900">
                <%= number_to_currency(amount.cents / 100.0, unit: amount.currency.iso_code) %>
              </strong>
            <% end %>
          </div>
        </div>
      </div>
      <div class="flex mb-2 ms-7 justify-between">
        <div>
          <% if plan.ends_on.present? %>
            <p class="text-[11px] tracking-wide text-slate-400">Available until <%= l(plan.ends_on, format: :long) %></p>
          <% end %>
          <% if plan.description.present? %>
            <p class="text-xs text-slate-500"><%= plan.description %></p>
          <% end %>
        </div>
        <p class="text-[11px] tracking-wide text-slate-400">Due Today</p>
      </div>
      <div class="flex-1 space-y-2">
        <% if breakdown.any? %>
          <div class="space-y-3 rounded-lg border border-slate-200 bg-white px-4 py-4 text-sm text-slate-600">
            <p class="text-sm font-semibold text-slate-900">
              Upcoming installments
            </p>
            <ul class="space-y-2 text-xs text-slate-500">
              <% breakdown&.from(1).each_with_index do |(installment, amount), idx| %>
                <% due_date = installment[:due_on] %>
                <li class="flex items-center justify-between rounded-md bg-slate-50 px-3 py-2">
                  <span class="font-semibold text-slate-700">
                    Installment <%= idx + 2 %>
                  </span>
                  <span class="text-slate-600">
                    <% if due_date.present? %>
                      Due <%= l(due_date, format: :long) %>
                    <% else %>
                      Due date to be confirmed
                    <% end %>
                  </span>
                  <span class="font-semibold text-slate-900">
                    <%= number_to_currency(amount.cents / 100.0, unit: amount.currency.iso_code) %>
                  </span>
                </li>
              <% end %>
            </ul>
            <div class="flex justify-end">
              <span class="text-gray-400 text-xs">Total Membership Cost: <%= number_to_currency(total_amount.cents / 100.0, unit: total_amount.currency.iso_code) %></span>
            </div>
          </div>
        <% else %>
          <p class="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-500">
            Installment amounts will be calculated during checkout.
          </p>
        <% end %>
      </div>
    </label>
  <% end %>
</div>
